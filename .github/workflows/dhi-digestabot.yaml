name: DHI Base Image Digestabot

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at midnight UTC to check for DHI base image updates
    - cron: "0 0 * * 0"

permissions:
  contents: write
  pull-requests: write

jobs:
  dhi-digestabot:
    name: DHI Base Image Digestabot
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit

    - name: Checkout repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false    # Don't store any credentials

    - name: Configure Git
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: Login to Docker Hub
      uses: docker/login-action@3d58c274f17dffee475a5520cbe67f0a882c4dbb # v3.3.0
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Verify DHI image access
      run: |
        echo "Testing access to DHI base images..."
        if docker manifest inspect docker.io/demonstrationorg/dhi-temurin:21-jdk-alpine3.22-dev >/dev/null 2>&1; then
          echo "âœ… Build image access verified"
        else
          echo "âŒ Cannot access build image - check authentication"
          exit 1
        fi
        if docker manifest inspect docker.io/demonstrationorg/dhi-temurin:21-alpine3.22_whale1 >/dev/null 2>&1; then
          echo "âœ… Runtime image access verified"
        else
          echo "âŒ Cannot access runtime image - check authentication"
          exit 1
        fi
    # Run digestabot to update digests only (no PR creation - avoids gitsign/auth issues)
    - name: Update DHI base image digests
      uses: chainguard-dev/digestabot@a3b776c1ca57d3127c85578cde8fef6eed3c75d3 # v1.2.3
      id: digestabot
      env:
        GITHUB_TOKEN: ${{ secrets.KUFULI_TOKEN }}
        CREATE_PR: false  # Disable internal PR creation to avoid gitsign and duplicate auth headers
      with:
        working-dir: "."
        signoff: false

    # Check for changes made by digestabot
    - name: Check for digest changes
      id: check-changes
      run: |
        if git diff --quiet; then
          echo "No digest updates needed"
          echo "has-changes=false" >> $GITHUB_OUTPUT
        else
          echo "Digest updates found:"
          git diff --stat
          echo "has-changes=true" >> $GITHUB_OUTPUT
        fi

    # Clear all git credentials to prevent duplicate Authorization headers
    - name: Clear git credentials before PR creation
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        echo "=== Aggressively clearing ALL git credentials ==="
        
        # Unset all extraheader configs at all levels
        git config --local --unset-all http.https://github.com/.extraheader 2>/dev/null || true
        git config --global --unset-all http.https://github.com/.extraheader 2>/dev/null || true
        git config --system --unset-all http.https://github.com/.extraheader 2>/dev/null || true
        
        # Also clear any http.extraheader without domain specificity
        git config --local --unset-all http.extraheader 2>/dev/null || true
        git config --global --unset-all http.extraheader 2>/dev/null || true
        git config --system --unset-all http.extraheader 2>/dev/null || true
        
        # Remove credential files and helpers
        rm -f ~/.git-credentials 2>/dev/null || true
        rm -f ~/.gitconfig 2>/dev/null || true
        git config --local --unset-all credential.helper 2>/dev/null || true
        git config --global --unset-all credential.helper 2>/dev/null || true
        
        # Clear any environment variables that might contain auth
        unset GIT_ASKPASS GIT_USERNAME GIT_PASSWORD GITHUB_TOKEN || true
        
        # Verify complete cleanup
        echo "=== Git config after aggressive cleanup ==="
        git config --list 2>/dev/null | grep -iE "(http|credential|extraheader)" || echo "âœ… No HTTP/credential configs found (expected)"
        
        echo "=== Credentials cleared successfully ==="

    # Create PR with clean credentials (separate from digestabot to avoid gitsign issues)
    - name: Create Pull Request
      id: create-pr
      if: steps.check-changes.outputs.has-changes == 'true'
      uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.6
      with:
        token: ${{ secrets.KUFULI_TOKEN }}
        commit-message: 'Update DHI base image digests'
        title: 'Update DHI base image digests'
        branch: dhi-digestabot
        delete-branch: true
        labels: 'dependencies,security,dhi-images'
        committer: 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>'
        author: 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>'
        body: |
          ðŸ›¡ï¸ **DHI Base Image Security Update**
          
          This automated PR updates our DHI (Docker Hardened Images) base image digests to the latest secure versions.
          
          ## ðŸ” Images Updated
          
          **Build Stage**: demonstrationorg/dhi-temurin:21-jdk-alpine3.22-dev  
          **Runtime Stage**: demonstrationorg/dhi-temurin:21-alpine3.22_whale1
          

          ## ðŸ›¡ï¸ Security Benefits
          - âœ… Latest security patches applied
          - âœ… Vulnerability fixes included
          - âœ… Supply chain integrity maintained
          - âœ… Reproducible builds preserved
          
          ## ðŸ”— DHI Golden Images
          These images are part of our DHI (Docker Hardened Images) golden image strategy, providing:
          - Pre-hardened base configurations
          - Reduced attack surface
          - Enterprise security standards
          - Automated security updates

    - name: Summary
      if: steps.create-pr.outputs.pull-request-number
      run: |
        echo "## DHI Base Image Update" >> $GITHUB_STEP_SUMMARY
        echo "A pull request has been created to update the DHI base image digests." >> $GITHUB_STEP_SUMMARY
        echo "**Pull Request Number:** #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Images Currently Tracked:" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Stage:** demonstrationorg/dhi-temurin:21-jdk-alpine3.22-dev@sha256:d32f08b3aa18668323a82e3ffb297cb1030dc1ed0d85b9786204538ab6e1a32a" >> $GITHUB_STEP_SUMMARY
        echo "- **Runtime Stage:** demonstrationorg/dhi-temurin:21-alpine3.22_whale1@sha256:b40246be5f213ba0aa548a8ab1b7536e1c6e8909000acbdab30157b12579249e" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Security Benefits:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ Images pinned to specific digests for reproducible builds" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ›¡ï¸ Automatic tracking of DHI security updates" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ Complete audit trail of base image changes" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸš€ Supply chain integrity through cryptographic verification" >> $GITHUB_STEP_SUMMARY
        echo "- â¬…ï¸ Shift-left security with proactive vulnerability management" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### DHI Golden Images Benefits:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Pre-hardened container foundation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security patches applied by experts" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Reduced attack surface compared to standard images" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Compliance with security best practices" >> $GITHUB_STEP_SUMMARY

    - name: No Updates Summary
      if: steps.check-changes.outputs.has-changes == 'false'
      run: |
        echo "## âœ… DHI Base Images Up to Date" >> $GITHUB_STEP_SUMMARY
        echo "No digest updates needed - all DHI base images are current." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Images Monitored:" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Stage:** demonstrationorg/dhi-temurin:21-jdk-alpine3.22-dev" >> $GITHUB_STEP_SUMMARY
        echo "- **Runtime Stage:** demonstrationorg/dhi-temurin:21-alpine3.22_whale1" >> $GITHUB_STEP_SUMMARY